# Release Pipeline - Triggered on version tags
# Builds and publishes releases for all platforms

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  # ============================================
  # Validate Release
  # ============================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  # ============================================
  # Build macOS Agent
  # ============================================
  build-macos:
    name: Build macOS Agent
    runs-on: macos-14
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Release
        working-directory: macos
        run: |
          xcodebuild -project ScreenControl.xcodeproj \
            -scheme ScreenControl \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            build

      - name: Verify no TestServer in Release
        working-directory: macos
        run: |
          if nm build/Build/Products/Release/ScreenControl.app/Contents/MacOS/ScreenControl 2>/dev/null | grep -q "TestServer"; then
            echo "✗ SECURITY FAIL: TestServer in release!"
            exit 1
          fi
          echo "✓ TestServer correctly excluded"

      - name: Create DMG
        working-directory: macos
        run: |
          mkdir -p dmg-contents
          cp -R build/Build/Products/Release/ScreenControl.app dmg-contents/
          hdiutil create -volname "ScreenControl" \
            -srcfolder dmg-contents \
            -ov -format UDZO \
            "ScreenControl-${{ needs.validate.outputs.version }}-macOS.dmg"

      - name: Create ZIP
        working-directory: macos
        run: |
          cd build/Build/Products/Release
          zip -r "../../../../ScreenControl-${{ needs.validate.outputs.version }}-macOS.zip" ScreenControl.app

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: macos/ScreenControl-*.dmg
          retention-days: 30

      - name: Upload macOS ZIP
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: macos/ScreenControl-*.zip
          retention-days: 30

  # ============================================
  # Build Linux Service
  # ============================================
  build-linux:
    name: Build Linux Service
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libx11-dev libxtst-dev libpng-dev libssl-dev

      - name: Build Service
        working-directory: service
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Create tarball
        run: |
          mkdir -p release-linux
          cp service/build/screencontrol_service release-linux/
          cp README.md release-linux/ 2>/dev/null || true
          tar -czvf ScreenControl-${{ needs.validate.outputs.version }}-linux-x64.tar.gz release-linux

      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: ScreenControl-*.tar.gz
          retention-days: 30

  # ============================================
  # Test macOS Release Build
  # ============================================
  test-macos:
    name: Test macOS Release
    runs-on: macos-14
    needs: build-macos

    steps:
      - name: Download macOS ZIP
        uses: actions/download-artifact@v4
        with:
          name: macos-zip
          path: .

      - name: Extract and verify
        run: |
          unzip ScreenControl-*.zip
          # Verify binary exists and is executable
          if [ ! -x "ScreenControl.app/Contents/MacOS/ScreenControl" ]; then
            echo "✗ Binary not executable"
            exit 1
          fi
          echo "✓ macOS release verified"

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build-macos, build-linux, test-macos]
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          cat << EOF > release-notes.md
          ## ScreenControl v$VERSION

          ### Downloads

          | Platform | File | Description |
          |----------|------|-------------|
          | macOS | ScreenControl-$VERSION-macOS.dmg | Disk image installer |
          | macOS | ScreenControl-$VERSION-macOS.zip | ZIP archive |
          | Linux | ScreenControl-$VERSION-linux-x64.tar.gz | Linux x64 service |

          ### Installation

          **macOS:**
          1. Download the DMG file
          2. Open and drag ScreenControl to Applications
          3. Grant Accessibility and Screen Recording permissions

          **Linux:**
          1. Extract the tarball
          2. Run the service: \`./screencontrol_service\`
          3. Configure systemd for auto-start (optional)

          ### Changes

          See commit history for changes in this release.
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: ScreenControl v${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: |
            artifacts/macos-dmg/*.dmg
            artifacts/macos-zip/*.zip
            artifacts/linux-tarball/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
