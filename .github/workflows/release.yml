# Release Pipeline - Triggered on version tags
# Builds and publishes releases for all platforms

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Validate Release
  # ============================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify package version
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "Package version: $PKG_VERSION"
          if [ "$PKG_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "⚠️ Package version doesn't match release version"
            echo "This may be intentional for workflow_dispatch releases"
          fi

      - name: Run tests
        run: npm test

  # ============================================
  # Build TypeScript Package
  # ============================================
  build-npm:
    name: Build NPM Package
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Create package
        run: npm pack

      - name: Upload npm package
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: '*.tgz'
          retention-days: 30

  # ============================================
  # Build macOS Agent
  # ============================================
  build-macos:
    name: Build macOS Agent
    runs-on: macos-14
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Release
        working-directory: macos
        run: |
          xcodebuild -project ScreenControl.xcodeproj \
            -scheme ScreenControl \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            build

      - name: Verify no TestServer in Release
        working-directory: macos
        run: |
          if nm build/Build/Products/Release/ScreenControl.app/Contents/MacOS/ScreenControl 2>/dev/null | grep -q "TestServer"; then
            echo "✗ SECURITY FAIL: TestServer in release!"
            exit 1
          fi
          echo "✓ TestServer correctly excluded"

      - name: Create DMG
        working-directory: macos
        run: |
          mkdir -p dmg-contents
          cp -R build/Build/Products/Release/ScreenControl.app dmg-contents/
          hdiutil create -volname "ScreenControl" \
            -srcfolder dmg-contents \
            -ov -format UDZO \
            "ScreenControl-${{ needs.validate.outputs.version }}-macOS.dmg"

      - name: Create ZIP
        working-directory: macos
        run: |
          cd build/Build/Products/Release
          zip -r "../../../../ScreenControl-${{ needs.validate.outputs.version }}-macOS.zip" ScreenControl.app

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: macos/ScreenControl-*.dmg
          retention-days: 30

      - name: Upload macOS ZIP
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: macos/ScreenControl-*.zip
          retention-days: 30

  # ============================================
  # Test macOS Release Build
  # ============================================
  test-macos:
    name: Test macOS Release
    runs-on: macos-14
    needs: build-macos

    steps:
      - name: Download macOS ZIP
        uses: actions/download-artifact@v4
        with:
          name: macos-zip
          path: .

      - name: Extract and verify
        run: |
          unzip ScreenControl-*.zip
          # Verify binary exists and is executable
          if [ ! -x "ScreenControl.app/Contents/MacOS/ScreenControl" ]; then
            echo "✗ Binary not executable"
            exit 1
          fi
          echo "✓ macOS release verified"

  # ============================================
  # Build Web Platform
  # ============================================
  build-web:
    name: Build Web Platform
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Generate Prisma client
        working-directory: web
        run: npx prisma generate
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"

      - name: Build Next.js
        working-directory: web
        run: npm run build
        env:
          DATABASE_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"

      - name: Create web bundle
        run: |
          tar -czf web-bundle-${{ needs.validate.outputs.version }}.tar.gz \
            web/.next \
            web/public \
            web/package.json \
            web/package-lock.json \
            web/prisma \
            web/server.ts \
            web/next.config.ts

      - name: Upload web bundle
        uses: actions/upload-artifact@v4
        with:
          name: web-bundle
          path: web-bundle-*.tar.gz
          retention-days: 30

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build-npm, build-macos, test-macos, build-web]
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          cat << EOF > release-notes.md
          ## ScreenControl v$VERSION

          ### Downloads

          | Platform | File | Description |
          |----------|------|-------------|
          | macOS | ScreenControl-$VERSION-macOS.dmg | Disk image installer |
          | macOS | ScreenControl-$VERSION-macOS.zip | ZIP archive |
          | npm | mcp-eyes-$VERSION.tgz | NPM package |
          | Web | web-bundle-$VERSION.tar.gz | Server deployment bundle |

          ### Installation

          **macOS:**
          1. Download the DMG file
          2. Open and drag ScreenControl to Applications
          3. Grant Accessibility and Screen Recording permissions

          **npm:**
          \`\`\`bash
          npm install -g mcp-eyes@$VERSION
          \`\`\`

          ### Changes

          See [CHANGELOG.md](CHANGELOG.md) for full change history.
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: ScreenControl v${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: |
            artifacts/macos-dmg/*.dmg
            artifacts/macos-zip/*.zip
            artifacts/npm-package/*.tgz
            artifacts/web-bundle/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Publish to NPM
  # ============================================
  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
