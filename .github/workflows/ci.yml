name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  # ============================================
  # macOS Agent Build
  # ============================================
  build-macos-agent:
    name: Build macOS Agent
    runs-on: macos-14  # Apple Silicon runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Debug Agent
        working-directory: macos
        run: |
          xcodebuild -project ScreenControl.xcodeproj \
            -scheme ScreenControl \
            -configuration Debug \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            build

      - name: Verify TestServer in Debug Build
        working-directory: macos
        run: |
          if nm build/Build/Products/Debug/ScreenControl.app/Contents/MacOS/ScreenControl | grep -q "TestServer"; then
            echo "✓ TestServer compiled into debug build"
          else
            echo "✗ FAIL: TestServer NOT found in debug build"
            exit 1
          fi

      - name: Build Release Agent
        working-directory: macos
        run: |
          xcodebuild -project ScreenControl.xcodeproj \
            -scheme ScreenControl \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            build

      - name: Verify TestServer NOT in Release Build
        working-directory: macos
        run: |
          if nm build/Build/Products/Release/ScreenControl.app/Contents/MacOS/ScreenControl 2>/dev/null | grep -q "TestServer"; then
            echo "✗ SECURITY FAIL: TestServer found in release build!"
            exit 1
          else
            echo "✓ TestServer correctly excluded from release build"
          fi

      - name: Upload Debug Build
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-Debug-macOS
          path: macos/build/Build/Products/Debug/ScreenControl.app
          retention-days: 7

      - name: Upload Release Build
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-Release-macOS
          path: macos/build/Build/Products/Release/ScreenControl.app
          retention-days: 30

  # ============================================
  # macOS Installer (.pkg) - Signed
  # ============================================
  build-macos-pkg:
    name: Build macOS Installer
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install dependencies
        run: brew install openssl@3

      - name: Import signing certificates
        if: ${{ env.MACOS_CERTIFICATE != '' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate from secrets
          echo -n "$MACOS_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$MACOS_CERTIFICATE_PWD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Verify certificates imported
          echo "Verifying certificates..."
          security find-identity -v -p codesigning $KEYCHAIN_PATH

      - name: Build and sign pkg installer
        working-directory: service/install/macos/pkg
        run: |
          chmod +x build_pkg.sh
          if [ -n "${{ secrets.MACOS_CERTIFICATE }}" ]; then
            echo "Building signed installer..."
            ./build_pkg.sh --version 1.2.0 \
              --sign "Developer ID Installer: Key Network Services Ltd (LZ7T6LSFQ5)" \
              --app-sign "Developer ID Application: Key Network Services Ltd (LZ7T6LSFQ5)"
          else
            echo "Building unsigned installer (no certificates configured)..."
            ./build_pkg.sh --version 1.2.0
          fi
        env:
          OPENSSL_ROOT_DIR: /opt/homebrew/opt/openssl@3

      - name: Notarize pkg
        if: ${{ env.APPLE_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          PKG_PATH="service/install/macos/pkg/output/ScreenControl-1.2.0.pkg"
          if [ -f "$PKG_PATH" ]; then
            echo "Submitting for notarization..."
            xcrun notarytool submit "$PKG_PATH" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_PASSWORD" \
              --wait

            echo "Stapling notarization ticket..."
            xcrun stapler staple "$PKG_PATH"
          fi

      - name: Verify pkg
        run: |
          if [ -f "service/install/macos/pkg/output/ScreenControl-1.2.0.pkg" ]; then
            echo "✅ macOS pkg build successful"
            ls -la service/install/macos/pkg/output/
            # Check if signed
            pkgutil --check-signature service/install/macos/pkg/output/ScreenControl-1.2.0.pkg || true
          else
            echo "❌ macOS pkg build failed"
            exit 1
          fi

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true

      - name: Upload macOS pkg
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-macOS-pkg
          path: service/install/macos/pkg/output/*.pkg
          retention-days: 30

  # ============================================
  # macOS Agent Integration Tests (via TestServer)
  # Note: These tests require accessibility permissions which
  # CI runners don't have. They're informational only.
  # ============================================
  test-macos-agent:
    name: Test macOS Agent
    runs-on: macos-14
    needs: build-macos-agent
    continue-on-error: true  # Don't fail the pipeline for permission issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Debug Build
        uses: actions/download-artifact@v4
        with:
          name: ScreenControl-Debug-macOS
          path: agent/ScreenControl.app

      - name: Make agent executable
        run: chmod +x agent/ScreenControl.app/Contents/MacOS/ScreenControl

      - name: Start Agent
        run: |
          open agent/ScreenControl.app
          echo "Waiting for agent startup..."
          sleep 5

      - name: Wait for TestServer
        run: |
          echo "Waiting for TestServer to be ready..."
          for i in {1..15}; do
            if curl -s http://localhost:3456/ping 2>/dev/null | grep -q '"pong":true'; then
              echo "✓ TestServer is ready"
              exit 0
            fi
            echo "  Attempt $i/15..."
            sleep 2
          done
          echo "✗ TestServer failed to start"
          exit 1

      - name: Test ping endpoint
        run: |
          RESPONSE=$(curl -s http://localhost:3456/ping)
          echo "Ping response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"debug":true'; then
            echo "✓ Confirmed debug build"
          else
            echo "✗ Not a debug build"
            exit 1
          fi

      - name: Test getState endpoint
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:3456 \
            -H "Content-Type: application/json" \
            -d '{"method": "getState"}')
          echo "State response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"connected"'; then
            echo "✓ getState works correctly"
          else
            echo "✗ getState failed"
            exit 1
          fi

      - name: Stop Agent
        if: always()
        run: |
          curl -s -X POST http://localhost:3456 \
            -H "Content-Type: application/json" \
            -d '{"method": "quit"}' || true
          sleep 2
          echo "Agent stopped"

  # ============================================
  # macOS Service Build (standalone C++ service)
  # ============================================
  build-macos-service:
    name: Build macOS Service
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install openssl@3

      - name: Build Service with CMake
        working-directory: service
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          make -j$(sysctl -n hw.ncpu)

      - name: Verify Build
        run: |
          if [ -f "service/build/bin/ScreenControlService" ]; then
            echo "✅ macOS service build successful"
            ls -la service/build/bin/ScreenControlService
          else
            echo "❌ macOS service build failed"
            find service/build -name "ScreenControl*" -type f 2>/dev/null || true
            exit 1
          fi

      - name: Upload macOS Service
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-Service-macOS
          path: service/build/bin/ScreenControlService
          retention-days: 30

  # ============================================
  # Linux Service Build
  # ============================================
  build-linux-service:
    name: Build Linux Service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential pkg-config \
            libx11-dev libxrandr-dev libxtst-dev libpng-dev \
            libssl-dev libsecret-1-dev

      - name: Build Service
        working-directory: service
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Verify Build
        run: |
          if [ -f "service/build/bin/ScreenControlService" ]; then
            echo "✅ Linux service build successful"
            ls -la service/build/bin/ScreenControlService
          else
            echo "❌ Linux service build failed"
            find service/build -name "ScreenControl*" -type f 2>/dev/null || true
            exit 1
          fi

      - name: Upload Linux Build
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-Service-Linux
          path: service/build/bin/ScreenControlService
          retention-days: 30

  # ============================================
  # Windows Service Build
  # ============================================
  build-windows-service:
    name: Build Windows Service
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Service with CMake
        working-directory: service
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

      - name: Verify Build
        shell: pwsh
        run: |
          $exe = "service/build/bin/Release/ScreenControlService.exe"
          if (Test-Path $exe) {
            Write-Host "✅ Windows service build successful"
            Get-Item $exe
          } else {
            Write-Host "❌ Windows service build failed"
            Get-ChildItem -Recurse service/build -Filter "*.exe" | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Upload Windows Service
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-Service-Windows
          path: service/build/bin/Release/ScreenControlService.exe
          retention-days: 30

  # ============================================
  # Windows Tray App Build
  # ============================================
  build-windows-tray:
    name: Build Windows Tray App
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build Tray App
        working-directory: windows/ScreenControlTray
        run: |
          dotnet restore
          dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o publish

      - name: Verify Build
        shell: pwsh
        run: |
          $exe = "windows/ScreenControlTray/publish/ScreenControlTray.exe"
          if (Test-Path $exe) {
            Write-Host "✅ Windows tray app build successful"
            Get-Item $exe
          } else {
            Write-Host "❌ Windows tray app build failed"
            exit 1
          }

      - name: Upload Windows Tray App
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-Tray-Windows
          path: windows/ScreenControlTray/publish/ScreenControlTray.exe
          retention-days: 30

  # ============================================
  # Windows Credential Provider Build
  # ============================================
  build-windows-credential-provider:
    name: Build Windows Credential Provider
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Credential Provider with CMake
        working-directory: service/src/platform/windows/credential_provider
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Verify Build
        shell: pwsh
        run: |
          $dll = "service/src/platform/windows/credential_provider/build/bin/Release/ScreenControlCP.dll"
          if (Test-Path $dll) {
            Write-Host "✅ Windows credential provider build successful"
            Get-Item $dll
          } else {
            Write-Host "❌ Windows credential provider build failed"
            Get-ChildItem -Recurse service/src/platform/windows/credential_provider/build -Filter "*.dll" | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Upload Windows Credential Provider
        uses: actions/upload-artifact@v4
        with:
          name: ScreenControl-CredentialProvider-Windows
          path: service/src/platform/windows/credential_provider/build/bin/Release/ScreenControlCP.dll
          retention-days: 30

  # ============================================
  # Status Check
  # ============================================
  status-check:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [build-macos-agent, build-macos-service, build-macos-pkg, build-linux-service, build-windows-service, build-windows-tray, build-windows-credential-provider]
    if: always()

    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build-macos-agent.result }}" != "success" ]; then
            echo "❌ macOS agent build failed"
            exit 1
          fi
          if [ "${{ needs.build-macos-service.result }}" != "success" ]; then
            echo "❌ macOS service build failed"
            exit 1
          fi
          if [ "${{ needs.build-macos-pkg.result }}" != "success" ]; then
            echo "❌ macOS pkg build failed"
            exit 1
          fi
          if [ "${{ needs.build-linux-service.result }}" != "success" ]; then
            echo "❌ Linux service build failed"
            exit 1
          fi
          if [ "${{ needs.build-windows-service.result }}" != "success" ]; then
            echo "❌ Windows service build failed"
            exit 1
          fi
          if [ "${{ needs.build-windows-tray.result }}" != "success" ]; then
            echo "❌ Windows tray app build failed"
            exit 1
          fi
          if [ "${{ needs.build-windows-credential-provider.result }}" != "success" ]; then
            echo "❌ Windows credential provider build failed"
            exit 1
          fi
          echo "✅ All builds passed!"
