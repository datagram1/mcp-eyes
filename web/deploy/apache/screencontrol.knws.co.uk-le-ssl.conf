<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName screencontrol.knws.co.uk

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"

    # Proxy settings
    ProxyPreserveHost On

    # WebSocket-specific timeout (5 minutes)
    ProxyTimeout 300

    # WebSocket support for agent connections at /ws
    # Using RewriteRule only (not both RewriteRule and ProxyPass)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/ws$ ws://127.0.0.1:3002/ws [P,L]

    # Proxy to Next.js on port 3002 (general catch-all)
    # Exclude /ws since it's handled by RewriteRule above
    ProxyPass /ws !
    ProxyPass / http://127.0.0.1:3002/
    ProxyPassReverse / http://127.0.0.1:3002/

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/screencontrol_error.log
    CustomLog ${APACHE_LOG_DIR}/screencontrol_access.log combined

    SSLCertificateFile /etc/letsencrypt/live/screencontrol.knws.co.uk/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/screencontrol.knws.co.uk/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
