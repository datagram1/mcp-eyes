#!/bin/bash
#
# ScreenControl Service Postinstall Script
#
# This script runs after the pkg installer copies files.
# It sets up directories, permissions, and starts the service.
#

SERVICE_ID="com.screencontrol.service"
SERVICE_BINARY="/Library/PrivilegedHelperTools/${SERVICE_ID}"
SERVICE_PLIST="/Library/LaunchDaemons/${SERVICE_ID}.plist"
CONFIG_DIR="/Library/Application Support/ScreenControl"
LOG_DIR="/Library/Logs/ScreenControl"
APP_PATH="/Applications/ScreenControl.app"

# Log to installer log
log() {
    echo "[ScreenControl Postinstall] $1"
}

log "Starting postinstall..."

# Create directories
log "Creating directories..."
mkdir -p "$CONFIG_DIR"
mkdir -p "$LOG_DIR"

# Set permissions on service binary
log "Setting service permissions..."
chmod 755 "$SERVICE_BINARY"
chown root:wheel "$SERVICE_BINARY"

# Set permissions on plist
chmod 644 "$SERVICE_PLIST"
chown root:wheel "$SERVICE_PLIST"

# Set directory permissions
chmod 755 "$CONFIG_DIR"
chmod 755 "$LOG_DIR"
chown root:wheel "$CONFIG_DIR"
chown root:wheel "$LOG_DIR"

# Create default config if not exists
if [[ ! -f "${CONFIG_DIR}/config.json" ]]; then
    log "Creating default configuration..."
    cat > "${CONFIG_DIR}/config.json" << 'EOF'
{
    "httpPort": 3459,
    "guiBridgePort": 3460,
    "controlServerUrl": "wss://screencontrol.knws.co.uk/ws",
    "agentName": "",
    "autoStart": true,
    "enableLogging": true
}
EOF
    chmod 644 "${CONFIG_DIR}/config.json"
fi

# Load service
log "Loading service..."
launchctl load "$SERVICE_PLIST"

# Wait for service to start
sleep 2

# Verify service is running
if launchctl list | grep -q "$SERVICE_ID" 2>/dev/null; then
    log "Service started successfully"
else
    log "Warning: Service may not have started correctly"
fi

# Set app permissions (if installed)
if [[ -d "$APP_PATH" ]]; then
    log "Setting application permissions..."
    chmod -R 755 "$APP_PATH"
    chown -R root:wheel "$APP_PATH"

    # Remove quarantine flag
    xattr -rd com.apple.quarantine "$APP_PATH" 2>/dev/null || true
fi

# Register login item for current user (optional - user can enable in settings)
# This is handled by the app itself now

log "Postinstall complete"
log "Service installed at: $SERVICE_BINARY"
log "Configuration at: ${CONFIG_DIR}/config.json"
log "Logs at: ${LOG_DIR}/"

exit 0
